<div class="relative overflow-hidden">
  <!-- Animated Background -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div
      class="absolute -top-40 -right-40 w-80 h-80 bg-blue-50 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
    </div>
    <div
      class="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-50 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
    </div>
  </div>

  <!-- Main Card -->
  <mat-card
    class="relative bg-white/95 backdrop-blur-sm !rounded-2xl !shadow-2xl overflow-hidden border border-white/50">

    <!-- ========== HEADER ========== -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-5 relative overflow-hidden">
      <div
        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full animate-shimmer">
      </div>

      <div class="flex items-start justify-between relative z-10">
        <!-- Title Section -->
        <div class="flex items-start gap-4 flex-1 min-w-0">
          <div
            class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
            <mat-icon class="!text-2xl !w-6 !h-6 text-white">assignment_turned_in</mat-icon>
          </div>
          <div class="flex-1 min-w-0">
            <h2 class="text-xl font-bold text-white mb-1 break-words">{{ task.title }}</h2>
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-blue-100">
              <span class="flex items-center gap-1">
                <mat-icon class="!text-sm !w-4 !h-4">schedule</mat-icon>
                {{ task.createdAt | date:'MMM d, yyyy · h:mm a' }}
              </span>
              <span class="w-1 h-1 rounded-full bg-blue-300"></span>
              <span class="flex items-center gap-1">
                <mat-icon class="!text-sm !w-4 !h-4">update</mat-icon>
                Updated {{ task.updatedAt ? (task.updatedAt | date:'MMM d') : 'today' }}
              </span>
            </div>
          </div>
        </div>

        <!-- Close Button -->
        <button mat-icon-button (click)="close()"
          class="!w-10 !h-10 !flex !items-center !justify-center !p-0 bg-white/10 hover:bg-white/20 backdrop-blur rounded-xl transition-all duration-300 hover:rotate-90 flex-shrink-0"
          style="margin-top: -4px; margin-right: -4px;">
          <mat-icon class="!text-xl !w-5 !h-5 text-white">close</mat-icon>
        </button>
      </div>
    </div>

    <!-- ========== CONTENT ========== -->
    <mat-card-content class="!p-6 max-h-[70vh] overflow-y-auto custom-scrollbar bg-gray-50/50">

      <!-- ========== 3-COLUMN METRICS ========== -->
      <div class="grid grid-cols-12 gap-4 mb-6">

        <!-- Column 1: Description -->
        <div class="col-span-5">
          <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm h-full">
            <div class="flex items-center gap-2 mb-2">
              <div
                class="w-7 h-7 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-sm">
                <mat-icon class="!text-base !w-4 !h-4 text-white">description</mat-icon>
              </div>
              <span class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Description</span>
            </div>
            <div class="text-sm text-gray-600 leading-relaxed pl-1">
              {{ task.description || 'No description provided' }}
            </div>
          </div>
        </div>

        <!-- Column 2: Status -->
        <div class="col-span-3">
          <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm h-full flex flex-col">
            <div class="flex items-center gap-2 mb-3">
              <div
                class="w-7 h-7 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center shadow-sm">
                <mat-icon class="!text-base !w-4 !h-4 text-white">flag</mat-icon>
              </div>
              <span class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</span>
            </div>

            <!-- Current Status Badge -->
            <div class="flex items-center gap-2 mb-3">
              <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" [ngClass]="{
                  'bg-gray-400': task.status === statusEnum.Todo,
                  'bg-blue-500': task.status === statusEnum.InProgress,
                  'bg-green-500': task.status === statusEnum.Done
                }"></span>
                <span class="relative inline-flex rounded-full h-3 w-3" [ngClass]="{
                  'bg-gray-400': task.status === statusEnum.Todo,
                  'bg-blue-500': task.status === statusEnum.InProgress,
                  'bg-green-500': task.status === statusEnum.Done
                }"></span>
              </span>
              <span class="text-sm font-medium" [ngClass]="{
                'text-gray-700': task.status === statusEnum.Todo,
                'text-blue-700': task.status === statusEnum.InProgress,
                'text-green-700': task.status === statusEnum.Done
              }">{{ getStatusText(task.status) }}</span>
            </div>

            <!-- Status Selector - FILL appearance -->
            <div class="flex items-center gap-2 w-full">
              <mat-form-field appearance="fill" class="flex-1" subscriptSizing="dynamic">
                <mat-label class="text-xs">Change status</mat-label>
                <mat-select [value]="task.status" [disabled]="isUpdatingStatus"
                  (selectionChange)="onStatusChange($event.value)" class="!text-sm">
                  <mat-option [value]="statusEnum.Todo">Todo</mat-option>
                  <mat-option [value]="statusEnum.InProgress">In Progress</mat-option>
                  <mat-option [value]="statusEnum.Done">Done</mat-option>
                </mat-select>
              </mat-form-field>

              <div *ngIf="isUpdatingStatus" class="flex items-center">
                <mat-progress-spinner diameter="20" mode="indeterminate" color="primary"></mat-progress-spinner>
              </div>
            </div>
          </div>
        </div>

        <!-- Column 3: Assignment Summary -->
        <div class="col-span-4">
          <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm h-full flex flex-col">
            <div class="flex items-center gap-2 mb-3">
              <div
                class="w-7 h-7 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center shadow-sm">
                <mat-icon class="!text-base !w-4 !h-4 text-white">person</mat-icon>
              </div>
              <span class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Assignment</span>
            </div>

            <!-- Current Assignee -->
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs text-gray-500">Current:</span>
              <div class="flex items-center gap-2">
                <ng-container *ngIf="task.assignedEmployeeId; else noAssignee">
                  <div class="flex items-center gap-1.5 px-2 py-1 bg-blue-50 rounded-full">
                    <div
                      class="w-5 h-5 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-[10px]">
                      {{ getEmployeeInitials(task.assignedEmployeeId) }}
                    </div>
                    <span class="text-xs font-medium text-blue-700 max-w-[100px] truncate">
                      {{ getEmployeeName(task.assignedEmployeeId).split(' ').pop() }}
                    </span>
                  </div>
                </ng-container>
                <ng-template #noAssignee>
                  <span class="text-xs text-gray-500 italic flex items-center gap-1">
                    <mat-icon class="!text-sm !w-4 !h-4">person_off</mat-icon>
                    Unassigned
                  </span>
                </ng-template>
              </div>
            </div>

            <!-- Quick Assign Dropdown + Save - NOW IN SAME LINE -->
            <div class="flex items-center gap-2 w-full">
              <mat-form-field appearance="fill" class="flex-1" subscriptSizing="dynamic">
                <mat-label class="text-xs">Assign to</mat-label>
                <mat-select [value]="getSelectedEmployeeId()"
                  (selectionChange)="onEmployeeSelectionChange($event.value)"
                  [disabled]="isAssigningEmployee || isLoadingEmployees" class="!text-sm">
                  <mat-option [value]="null">
                    <span class="text-sm">— Unassigned —</span>
                  </mat-option>
                  <mat-option *ngFor="let emp of projectEmployees" [value]="emp.id">
                    <span class="text-sm">{{ emp.fullName }}</span>
                    <span class="text-xs text-gray-500 ml-2">({{ emp.designation || 'Member' }})</span>
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <button mat-mini-fab color="primary" (click)="assignEmployee(getSelectedEmployeeId())"
                [disabled]="!isAssignmentChanged() || isAssigningEmployee" class="!w-9 !h-9 !shadow-md flex-shrink-0"
                matTooltip="Save assignment" matTooltipPosition="above">
                <mat-icon class="!text-base">save</mat-icon>
              </button>
            </div>

            <!-- Pending Indicator -->
            <div *ngIf="isAssignmentChanged()" class="flex items-center gap-1 mt-2">
              <mat-icon class="!text-sm !w-5 !h-5 text-amber-600">pending</mat-icon>
              <span class="text-xs text-amber-600">Unsaved changes</span>
            </div>

            <!-- Loading State -->
            <div *ngIf="isLoadingEmployees" class="flex items-center gap-2 mt-2">
              <mat-progress-spinner diameter="16" mode="indeterminate" color="accent"></mat-progress-spinner>
              <span class="text-xs text-gray-500">Loading team...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ========== TEAM SECTION ========== -->
      <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm mb-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div
              class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center shadow-sm">
              <mat-icon class="!text-lg !w-5 !h-5 text-white">people</mat-icon>
            </div>
            <div>
              <h3 class="text-sm font-semibold text-gray-800">Project Team</h3>
              <p class="text-xs text-gray-500">{{ projectEmployees.length }} members assigned</p>
            </div>
          </div>

          <!-- Team Stats -->
          <div class="flex items-center gap-3">
            <div class="flex -space-x-2">
              <div *ngFor="let emp of projectEmployees | slice:0:3"
                class="w-7 h-7 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 border-2 border-white flex items-center justify-center text-white font-bold text-xs shadow-sm"
                [matTooltip]="emp.fullName">
                {{ emp.fullName.charAt(0).toUpperCase() }}
              </div>
              <div *ngIf="projectEmployees.length > 3"
                class="w-7 h-7 rounded-full bg-gray-200 border-2 border-white flex items-center justify-center text-gray-600 font-bold text-xs shadow-sm"
                [matTooltip]="projectEmployees.length - 3 + ' more'">
                +{{ projectEmployees.length - 3 }}
              </div>
            </div>
          </div>
        </div>

        <!-- Employee Grid -->
        <div *ngIf="projectEmployees.length > 0; else noTeam" class="grid grid-cols-2 md:grid-cols-3 gap-2">
          <div *ngFor="let emp of projectEmployees"
            class="flex items-center gap-2 p-2 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all cursor-pointer border border-transparent hover:border-gray-200"
            [class.bg-blue-50]="emp.id === task.assignedEmployeeId"
            [class.border-blue-200]="emp.id === task.assignedEmployeeId" (click)="onEmployeeSelectionChange(emp.id)">

            <div
              class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-xs shadow-sm flex-shrink-0">
              {{ emp.fullName.charAt(0).toUpperCase() }}
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between">
                <span class="text-xs font-medium text-gray-800 truncate">{{ emp.fullName }}</span>
                <mat-icon *ngIf="emp.id === task.assignedEmployeeId"
                  class="!text-sm !w-4 !h-4 text-blue-600 flex-shrink-0 ml-1">check_circle</mat-icon>
              </div>
              <span class="text-xs text-gray-500 truncate block">{{ emp.designation || 'Team Member' }}</span>
            </div>
          </div>
        </div>

        <!-- No Team Template -->
        <ng-template #noTeam>
          <div
            class="flex flex-col items-center justify-center py-8 px-4 bg-gray-50 rounded-lg border border-dashed border-gray-200">
            <mat-icon class="!text-4xl !w-10 !h-10 text-gray-400 mb-2">people_outline</mat-icon>
            <p class="text-sm text-gray-600 mb-2">No team members assigned</p>
            <button mat-stroked-button color="primary" class="!text-xs !py-1 !px-3 !rounded-full">
              <mat-icon class="!text-sm !w-4 !h-4">add</mat-icon>
              Add Members
            </button>
          </div>
        </ng-template>
      </div>

      <!-- ========== ACTIVITY SECTION ========== -->
      <!-- ========== ACTIVITY SECTION ========== -->
      <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border border-purple-100">

        <!-- Line 1: Icon + Title + Badge -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <div
              class="w-8 h-8 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center shadow-sm">
              <mat-icon class="!text-lg !w-4 !h-6 text-white">chat</mat-icon>
            </div>
            <h3 class="text-sm font-semibold text-gray-800">Activity</h3>
          </div>
          <span
            class="inline-flex items-center justify-center px-2.5 py-1 bg-white text-purple-600 rounded-full border border-purple-200 text-xs font-medium">
            Coming soon
          </span>
        </div>

        <!-- Line 2: Subtitle -->
        <div class="ml-11 mb-2">
          <p class="text-xs text-gray-500">Comments & updates</p>
        </div>

        <!-- Line 3: Message -->
        <div class="ml-11 flex items-start gap-2">
          <mat-icon
            class="!text-sm !w-4 !h-4 !flex !items-center !justify-center text-purple-400 mt-0.5">forum</mat-icon>
          <p class="text-xs text-gray-600 leading-relaxed">
            Task discussions and activity tracking will be available soon
          </p>
        </div>
      </div>
    </mat-card-content>

    <!-- ========== FOOTER ========== -->
    <mat-card-actions class="!px-6 !py-3 !border-t !border-gray-200 bg-white flex justify-between items-center">
      <div class="flex items-center gap-3 text-xs text-gray-400">
        <span class="flex items-center gap-1">
          <span
            class="px-1.5 py-0.5 bg-gray-100 rounded text-gray-600 font-mono text-[10px] border border-gray-200">ESC</span>
          <span>Close</span>
        </span>
        <span class="flex items-center gap-1">
          <span
            class="px-1.5 py-0.5 bg-gray-100 rounded text-gray-600 font-mono text-[10px] border border-gray-200">⌘+S</span>
          <span>Save</span>
        </span>
      </div>
      <button mat-button (click)="close()"
        class="!rounded-full !px-5 !py-1.5 hover:!bg-gray-100 transition-all flex items-center justify-center">
        <mat-icon class="!text-lg !w-4 !h-4 !flex !items-center !justify-center !m-0 !p-0">close</mat-icon>
        <span class="text-sm font-medium leading-none ml-1">Close</span>
      </button>
    </mat-card-actions>
  </mat-card>
</div>